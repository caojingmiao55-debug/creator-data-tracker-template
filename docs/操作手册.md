# 创作者数据追踪器 - 操作手册

## 项目简介

这是一个多平台创作者数据采集与分析工具，支持：
- **社交平台**：抖音、小红书、视频号、公众号
- **网站分析**：Google Analytics 4

数据通过定时任务自动采集，存储在本地 SQLite 数据库，并通过网页仪表盘可视化展示。

---

## 一、环境准备

### 1.1 系统要求

- **操作系统**：macOS / Linux / Windows
- **Python**：3.10 或更高版本
- **浏览器**：Chrome 或 Chromium（用于自动化采集）

### 1.2 安装 Python 环境

```bash
# macOS (使用 Homebrew)
brew install python@3.12

# 或使用 pyenv
pyenv install 3.12.0
pyenv global 3.12.0
```

### 1.3 克隆项目

```bash
git clone https://github.com/your-username/creator-data-tracker.git
cd creator-data-tracker
```

### 1.4 创建虚拟环境

```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
# macOS / Linux:
source .venv/bin/activate
# Windows:
.venv\Scripts\activate
```

### 1.5 安装依赖

```bash
# 安装 Python 包
pip install -r requirements.txt

# 安装 Playwright 浏览器
playwright install chromium
```

---

## 二、配置文件

### 2.1 创建配置文件

```bash
# 复制示例配置
cp config.example.json config.json
```

### 2.2 配置平台 Cookie

编辑 `config.json`，填入各平台的 Cookie：

```json
{
  "douyin": {
    "enabled": true,
    "cookie": "从浏览器获取的 Cookie 字符串"
  },
  "xiaohongshu": {
    "enabled": true,
    "cookie": "从浏览器获取的 Cookie 字符串"
  },
  "shipinhao": {
    "enabled": true,
    "cookie": "从浏览器获取的 Cookie 字符串"
  }
}
```

### 2.3 获取 Cookie 的方法

1. 打开浏览器，登录对应平台的创作者后台
2. 按 `F12` 打开开发者工具
3. 切换到 `Network`（网络）标签
4. 刷新页面
5. 点击任意一个请求
6. 在 `Headers`（请求头）中找到 `Cookie` 字段
7. 复制整个 Cookie 值

**各平台后台地址：**
- 抖音：https://creator.douyin.com
- 小红书：https://creator.xiaohongshu.com
- 视频号：https://channels.weixin.qq.com

### 2.4 Cookie 有效期

| 平台 | 有效期 | 说明 |
|------|--------|------|
| 抖音 | ~14天 | 相对稳定 |
| 小红书 | ~14天 | 相对稳定 |
| 视频号 | ~4天 | 容易失效，建议频繁更新 |
| 公众号 | ~7天 | 中等 |

---

## 三、Google Analytics 配置（可选）

如果你有自己的网站并使用 Google Analytics，可以配置 GA 数据采集。

### 3.1 创建 Google Cloud 服务账号

1. 访问 [Google Cloud Console](https://console.cloud.google.com)
2. 创建新项目或选择已有项目
3. 启用 **Google Analytics Data API**
4. 创建服务账号：
   - IAM 和管理 → 服务账号 → 创建服务账号
   - 填写名称，如 `analytics-reader`
   - 创建 JSON 密钥并下载

### 3.2 授权服务账号访问 GA

1. 登录 [Google Analytics](https://analytics.google.com)
2. 管理 → 账号访问管理 → 添加用户
3. 输入服务账号邮箱（如 `analytics-reader@your-project.iam.gserviceaccount.com`）
4. 角色选择：**查看者**

### 3.3 配置凭证文件

```bash
# 创建 config 目录（如果不存在）
mkdir -p config

# 复制示例文件
cp config/ga_credentials.example.json config/ga_credentials.json

# 将下载的 JSON 密钥内容替换到文件中
```

### 3.4 获取 GA 属性 ID

1. 在 Google Analytics 中，进入 **管理**
2. 在属性列中，点击 **属性设置**
3. 复制 **属性 ID**（格式如 `123456789`）
4. 在 `config.json` 中填入：

```json
{
  "google_analytics": {
    "enabled": true,
    "property_id": "properties/123456789"
  }
}
```

---

## 四、运行数据采集

### 4.1 手动采集

```bash
# 激活虚拟环境
source .venv/bin/activate

# 采集所有平台数据
python collect_all.py

# 采集指定平台
python collect_all.py --platform douyin
python collect_all.py --platform xiaohongshu
python collect_all.py --platform shipinhao

# 采集平台数据 + GA 数据
python collect_all_with_ga.py
```

### 4.2 查看采集日志

```bash
# 查看最新日志
tail -f logs/collect.log

# 查看错误日志
cat logs/collect.error.log
```

### 4.3 验证数据

```bash
# 查看统计摘要
python query_db.py --stats

# 查看最近 7 天数据
python query_db.py --days 7

# 查看指定平台数据
python query_db.py --platform douyin

# 查看作品列表
python query_db.py --works
```

---

## 五、定时任务配置

### 5.1 macOS (launchd)

```bash
# 运行配置脚本
python scripts/setup_cron.py
```

或手动创建 plist 文件：

```bash
# 创建 plist 文件
cat > ~/Library/LaunchAgents/com.creator.tracker.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.creator.tracker</string>
    <key>ProgramArguments</key>
    <array>
        <string>/path/to/creator-data-tracker/.venv/bin/python</string>
        <string>/path/to/creator-data-tracker/collect_all_with_ga.py</string>
    </array>
    <key>StartCalendarInterval</key>
    <array>
        <dict>
            <key>Hour</key>
            <integer>9</integer>
            <key>Minute</key>
            <integer>0</integer>
        </dict>
        <dict>
            <key>Hour</key>
            <integer>21</integer>
            <key>Minute</key>
            <integer>0</integer>
        </dict>
    </array>
    <key>StandardOutPath</key>
    <string>/path/to/creator-data-tracker/logs/launchd.log</string>
    <key>StandardErrorPath</key>
    <string>/path/to/creator-data-tracker/logs/launchd.error.log</string>
    <key>WorkingDirectory</key>
    <string>/path/to/creator-data-tracker</string>
</dict>
</plist>
EOF

# 加载定时任务
launchctl load ~/Library/LaunchAgents/com.creator.tracker.plist

# 验证是否加载成功
launchctl list | grep creator
```

### 5.2 Linux (crontab)

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天 9:00 和 21:00 执行）
0 9,21 * * * cd /path/to/creator-data-tracker && .venv/bin/python collect_all_with_ga.py >> logs/cron.log 2>&1
```

### 5.3 Windows (任务计划程序)

1. 打开 **任务计划程序**
2. 创建基本任务
3. 设置触发器：每天 9:00 和 21:00
4. 操作：启动程序
   - 程序：`C:\path\to\creator-data-tracker\.venv\Scripts\python.exe`
   - 参数：`collect_all_with_ga.py`
   - 起始位置：`C:\path\to\creator-data-tracker`

---

## 六、数据仪表盘

### 6.1 本地查看

直接用浏览器打开 `index.html` 文件：

```bash
# macOS
open index.html

# Linux
xdg-open index.html

# Windows
start index.html
```

### 6.2 部署到 Vercel（推荐）

1. 在 [Vercel](https://vercel.com) 注册账号
2. 导入 GitHub 仓库
3. 部署设置保持默认即可
4. 部署完成后获得公开访问链接

### 6.3 部署到 GitHub Pages

```bash
# 在仓库设置中启用 GitHub Pages
# 选择 main 分支，根目录
# 访问：https://your-username.github.io/creator-data-tracker/
```

---

## 七、数据自动同步到 GitHub

### 7.1 配置 GitHub

在 `config.json` 中设置：

```json
{
  "settings": {
    "auto_push_to_github": true,
    "github_repo": "your-username/creator-data-tracker"
  }
}
```

### 7.2 配置 Git 凭证

```bash
# 设置 Git 用户信息
git config user.name "Your Name"
git config user.email "your-email@example.com"

# 使用 HTTPS + Personal Access Token
# 或配置 SSH 密钥
```

每次采集后，数据会自动提交并推送到 GitHub。

---

## 八、常见问题

### Q1: Cookie 失效怎么办？

**症状**：采集失败，日志显示 401 或重定向到登录页

**解决**：
1. 重新登录对应平台
2. 获取新的 Cookie
3. 更新 `config.json`

### Q2: Playwright 报错

**症状**：`playwright._impl._api_types.Error: Browser closed unexpectedly`

**解决**：
```bash
# 重新安装浏览器
playwright install chromium --with-deps
```

### Q3: GA 采集失败

**症状**：`google.api_core.exceptions.PermissionDenied`

**解决**：
1. 确认服务账号已添加到 GA 属性
2. 确认属性 ID 正确
3. 等待 24 小时（新添加的权限可能需要时间生效）

### Q4: 定时任务不执行

**macOS**：
```bash
# 检查 launchd 状态
launchctl list | grep creator

# 查看错误
launchctl error <error_code>

# 重新加载
launchctl unload ~/Library/LaunchAgents/com.creator.tracker.plist
launchctl load ~/Library/LaunchAgents/com.creator.tracker.plist
```

**Linux**：
```bash
# 检查 cron 日志
grep CRON /var/log/syslog
```

### Q5: 视频号弹出登录窗口

**原因**：视频号 Cookie 失效较快

**解决**：
1. 手动扫码登录
2. 或禁用视频号采集：`"shipinhao": { "enabled": false }`

---

## 九、项目结构说明

```
creator-data-tracker/
├── collect_all.py          # 主采集脚本（平台数据）
├── collect_all_with_ga.py  # 包含 GA 的完整采集
├── query_db.py             # 数据库查询工具
├── index.html              # 数据仪表盘
├── config.json             # 配置文件（敏感，不提交）
├── config.example.json     # 配置模板
├── requirements.txt        # Python 依赖
│
├── config/                 # 凭证目录
│   ├── ga_credentials.json        # GA 服务账号密钥（敏感）
│   └── ga_credentials.example.json # GA 凭证模板
│
├── data/                   # 数据存储
│   ├── database.py         # SQLite 数据库模块
│   ├── tracker.db          # SQLite 数据库（自动生成）
│   ├── all_data.json       # 平台数据（自动生成）
│   └── ga_data.json        # GA 数据（自动生成）
│
├── scripts/                # 工具脚本
│   ├── collect_ga.py       # GA 数据采集
│   ├── sync_cookie_from_browser.py  # Cookie 同步
│   └── setup_cron.py       # 定时任务配置
│
├── assets/                 # 图片资源
├── logs/                   # 日志文件（自动生成）
└── docs/                   # 文档
```

---

## 十、数据安全提醒

以下文件包含敏感信息，**请勿公开分享**：

| 文件 | 内容 |
|------|------|
| `config.json` | 平台 Cookie、GitHub 配置 |
| `config/ga_credentials.json` | Google 服务账号私钥 |
| `.env.local` | Vercel 部署 Token |
| `data/tracker.db` | 个人数据 |
| `data/browser_data/` | 浏览器会话数据 |

这些文件已在 `.gitignore` 中排除，不会被提交到 Git。

---

## 十一、自定义开发

### 11.1 添加新平台

1. 在 `collect_all.py` 中添加新平台的采集逻辑
2. 在 `data/database.py` 中添加数据表
3. 在 `config.example.json` 中添加配置项
4. 在 `index.html` 中添加展示卡片

### 11.2 自定义仪表盘

修改 `index.html` 文件：
- 更换 Logo：替换 `assets/` 目录中的图片
- 修改标题：编辑 HTML 中的文字
- 添加图表：使用 Chart.js 添加新的可视化

### 11.3 导出数据

```bash
# 导出为 CSV
python scripts/export_csv.py

# 导出指定日期范围
python scripts/export_csv.py --start 2026-01-01 --end 2026-01-31
```

---

## 联系与支持

如有问题，请提交 [GitHub Issue](https://github.com/your-username/creator-data-tracker/issues)。

---

*最后更新：2026-02-04*
